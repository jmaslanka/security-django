upstream django {
	server django:5000;
}

server {
	listen 80 default_server;
	listen [::]:80 default_server;
	server_name djangobuttermilk.com api.djangobuttermilk.com;

	return 301 https://$server_name$request_uri;
}

server {
	listen 443 ssl http2;
    listen [::]:443 ssl http2;
	server_name djangobuttermilk.com api.djangobuttermilk.com;

	# Version number should be removed for every http response.
	server_tokens off;

	# enables server-side protection from BEAST attacks
    ssl_prefer_server_ciphers on;
    ssl_ciphers EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH;

    # Use secure protocol
    ssl_protocols TLSv1.3;

    # Session settings
    ssl_session_timeout  10m;
	ssl_session_cache shared:SSL:10m;
	ssl_session_tickets off;

	# Diffie-Hellman (DH) key exchange parameters
	ssl_dhparam /etc/nginx/certs/dhparam.pem;

	# OCSP stapling & certificates
	ssl_stapling on;
	ssl_stapling_verify on;
	resolver 8.8.8.8 8.8.4.4 valid=300s;
	resolver_timeout 5s;
	ssl_trusted_certificate /etc/nginx/certs/lets-encrypt-x3-cross-signed.pem;


	## https://www.owasp.org/index.php/OWASP_Secure_Headers_Project
	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
	add_header Referrer-Policy "no-referrer-when-downgrade" always;
	add_header X-Frame-Options "deny" always;
	add_header X-Content-Type-Options "nosniff" always;
	add_header X-XSS-Protection "1; mode=block" always;
	add_header X-Permitted-Cross-Domain-Policies "none";
	add_header Expect-CT "max-age=604800, enforce";
	add_header X-Robots-Tag none; 
	add_header Content-Security-Policy "
		default-src 'self';
		frame-ancestors 'none';
		script-src 'https://manager-static.s3.eu-central-1.amazonaws.com/';
		image-src 'https://manager-static.s3.eu-central-1.amazonaws.com/';
		style-src 'https://manager-static.s3.eu-central-1.amazonaws.com/';
		media-src 'https:';
		font-src 'https:';
		frame-src 'none';
		report-uri 'https://djangobuttermilk.com/_private/csp_report'" always;
	add_header Public-Key-Pins "
		pin-sha256='sRX+FYPIZEOTMfUNbhRiHDg5dtIoXrOxy4yJWU0bA3I=';
		pin-sha256='JzoH1BXiIo4MnH006aHzUeSlArvjtJTOXuSh/2XR1mc=';
		pin-sha256='sRHdihwgkaib1P1gxX8HFszlD+7/gTfNvuAybgLPNis=';
		pin-sha256='YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=';
		pin-sha256='C5+lpZ7tcVwmwQIMcRtPbsQtWLABXhQzejna0wHFr8M=';
		max-age=10; includeSubDomains;
	" always;  # increate max-age if working
	
	## Size Limits & Buffer Overflows 
	client_header_buffer_size 1k;
	client_body_buffer_size 100k;
	client_max_body_size 100k;
	large_client_header_buffers 2 1k;

	## Timeouts definition
	client_body_timeout   10;
	client_header_timeout 10;
	keepalive_timeout     5 5;
	keepalive_requests    100;
	send_timeout          10;


	location / {
		uwsgi_pass django;
		include uwsgi_params;
	}
}
